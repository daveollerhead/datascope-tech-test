pipeline {
  agent any

  triggers {
    pollSCM('* * * * *')
  }

  stages {
    // stage ('Clean workspace') {
    //   steps {
    //     cleanWs()
    //   }
    // } 

    stage('Restore packages') {
      steps {
        bat "dotnet restore Api/DatascopeTest.sln"
      }
    }

    stage('Build') {
      steps {
        bat "dotnet build Api/DatascopeTest.sln"
      }
    }

    stage('Unit Tests') {
      steps {
        bat "dotnet test API/DatascopeTest.Tests/DatascopeTest.Tests.csproj"
      }
    }

    stage('Build Docker Image') {
      steps {
        dir('Api'){
          bat "docker build -f test.Dockerfile -t datascopetest-integrationtests ."
        }        
      }
    }

    stage('Integration Test') {
      steps {
        bat "docker-compose -f items/api/docker-compose.yml up --abort-on-container-exit"
      }
    }
  }
}